<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Minecraft 物品获取命令生成器（Java 最新版 · 含数据组件）</title>
<style>
  :root{
    --bg:#0f1220;--panel:#171a2b;--panel-2:#1d2034;--text:#e7ebff;--muted:#aeb6d9;
    --accent:#7aa2ff;--ok:#6de39b;--warn:#ffd166;--danger:#ff6b6b;
    --border:#2a2f4a;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial}
  h1{font-size:20px;margin:14px 0}
  a{color:var(--accent);text-decoration:none}
  .wrap{display:grid;grid-template-columns:360px 1fr;gap:14px;padding:14px}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:12px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  label{display:block;margin:8px 0 4px;color:var(--muted);font-size:12px}
  input[type=text],input[type=number],select,textarea{
    width:100%;padding:8px 10px;border-radius:8px;border:1px solid var(--border);
    background:var(--panel-2);color:var(--text);outline:none
  }
  textarea{min-height:120px;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px}
  button{
    background:var(--panel-2);border:1px solid var(--border);color:var(--text);
    padding:8px 12px;border-radius:8px;cursor:pointer
  }
  button.primary{background:var(--accent);border-color:#5a80ff;color:#fff}
  button.ghost{background:transparent}
  .small{font-size:12px;color:var(--muted)}
  .grid{display:grid;gap:10px}
  .cols-2{grid-template-columns:1fr 1fr}
  .cols-3{grid-template-columns:repeat(3,1fr)}
  .chip{display:inline-flex;align-items:center;gap:6px;background:var(--panel-2);border:1px solid var(--border);padding:5px 8px;border-radius:999px}
  .tag{font-size:12px;color:var(--muted)}
  .danger{color:var(--danger)}
  .ok{color:var(--ok)}
  .section-title{display:flex;justify-content:space-between;align-items:center;margin:8px 0}
  .split{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
  .muted{color:var(--muted)}
  .kbd{padding:1px 6px;border:1px solid var(--border);border-bottom-color:#0003;border-radius:6px;background:#0004}
  .hr{height:1px;background:var(--border);margin:10px 0}
  .inline{display:inline-flex;gap:8px;align-items:center}
  .hint{font-size:12px;color:var(--muted)}
  .list{display:flex;flex-direction:column;gap:8px}
  .item{padding:10px;border:1px dashed var(--border);border-radius:10px;background:var(--panel-2)}
  .badge{padding:2px 6px;border:1px solid var(--border);border-radius:6px;background:#0004;font-size:12px;color:var(--muted)}
  .row-gap{display:flex;flex-direction:column;gap:8px}
  .checkboxes{display:flex;flex-wrap:wrap;gap:6px}
  .checkboxes label{margin:0;font-size:12px;color:var(--text);background:var(--panel-2);border:1px solid var(--border);padding:5px 8px;border-radius:8px}
  .pill{padding:2px 8px;border-radius:999px;background:#ffffff10;border:1px solid var(--border);font-size:12px}
  .code{padding:10px;border-radius:10px;background:#0b0e1a;border:1px solid var(--border);white-space:pre-wrap;font-family:ui-monospace,Menlo,Consolas,monospace}
  .right{justify-self:end}
  .hide{display:none}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  .subtle{opacity:.9}
  .danger-btn{border-color:#ff8a8a;color:#ff8a8a;background:#2b1212}
  .ok-btn{border-color:#7ee9b0;color:#0a1;background:#0f2a1d}
  .table{width:100%;border-collapse:separate;border-spacing:0 6px}
  .table th{font:12px/1.2 ui-monospace,Menlo,Consolas,monospace;color:var(--muted);text-align:left;padding:0 6px}
  .table td{padding:8px 6px;background:var(--panel-2);border:1px solid var(--border)}
  .table tr td:first-child{border-radius:8px 0 0 8px}
  .table tr td:last-child{border-radius:0 8px 8px 0}
  .nowrap{white-space:nowrap}
</style>
</head>
<body>
<div class="wrap">
  <!-- 左侧：表单 -->
  <div class="panel" id="left">
    <h1>物品编辑器 · Java 数据组件</h1>
    <div class="row">
      <div class="chip"><span>语法</span><span class="badge">/give item[components]</span></div>
      <div class="chip"><span>版本</span><span class="badge">1.21+（组件）</span></div>
    </div>

    <label>物品 ID（可省略 <span class="mono">minecraft:</span>）</label>
    <input id="itemId" type="text" placeholder="例：netherite_sword 或 minecraft:netherite_sword" />

    <div class="grid cols-2">
      <div>
        <label>数量</label>
        <input id="count" type="number" min="1" max="99" value="1" />
      </div>
      <div>
        <label>目标（选择器）</label>
        <input id="target" type="text" value="@p" />
      </div>
    </div>

    <div class="hr"></div>

    <div class="section-title">
      <h2 style="margin:0;font-size:16px">数据组件</h2>
      <div class="inline">
        <select id="componentSelect"></select>
        <button id="addComponent" class="primary">添加组件</button>
      </div>
    </div>
    <div id="componentsArea" class="list"></div>

    <div class="hr"></div>

    <div class="grid cols-2">
      <div class="row-gap">
        <div class="section-title">
          <b>预览命令</b>
          <div class="inline">
            <button id="copyCmd">复制</button>
          </div>
        </div>
        <div id="cmd" class="code mono"></div>
      </div>
      <div class="row-gap">
        <div class="section-title">
          <b>原始 JSON（整包 components）</b>
          <div class="inline">
            <button id="copyJson">复制</button>
          </div>
        </div>
        <textarea id="rawComponents" spellcheck="false" class="mono" placeholder='{"minecraft:enchantments":{"levels":{"minecraft:sharpness":5}}}'></textarea>
        <div class="inline" style="justify-content:space-between">
          <div class="hint">可直接编辑。下方两个按钮可同步到可视化或仅校验格式。</div>
          <div class="inline">
            <button id="validateJson" class="ghost">校验</button>
            <button id="applyJson" class="primary">载入到可视化</button>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- 右侧：帮助与说明 -->
  <div class="panel">
    <div class="section-title">
      <h2 style="margin:0;font-size:16px">使用提示</h2>
      <div class="pill">双向切换 原始JSON ↔ 可视化 ✅</div>
    </div>
    <ul class="list">
      <li class="item">
        <div class="row" style="justify-content:space-between">
          <b>1）组合方式</b><span class="tag">多个组件用逗号隔开：<span class="mono">diamond_sword[damage=2,rarity="rare"]</span></span>
        </div>
      </li>
      <li class="item">
        <b>2）颜色字段</b>
        <div class="hint">全部提供预设 + 自定义（色板 + 16 进制）两种；选“自定义”即可展开。</div>
      </li>
      <li class="item">
        <b>3）附魔与属性枚举</b>
        <div class="hint">附魔 ID、修饰符槽位（头/胸/腿/脚/主手/副手）等均用下拉/多选，避免拼写错误。</div>
      </li>
      <li class="item">
        <b>4）容器组件</b>
        <div class="hint">已加入 <span class="mono">container</span> 与 <span class="mono">container_loot</span>。支持添加槽位物品（包含内嵌组件），或使用战利品表。</div>
      </li>
      <li class="item">
        <b>5）切换原始 JSON 后如何回退？</b>
        <div class="hint">组件卡片右上角的“可视化/JSON”可来回切换；切回时会尝试解析 JSON 回填到表单。</div>
      </li>
    </ul>
  </div>
</div>

<template id="component-card">
  <div class="item">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div class="row" style="gap:8px;align-items:center">
        <b class="comp-title"></b>
        <span class="badge mono comp-id"></span>
      </div>
      <div class="row">
        <button class="ghost btn-toggle">转为原始JSON</button>
        <button class="ghost danger-btn btn-remove">删除</button>
      </div>
    </div>
    <div class="hr"></div>
    <div class="comp-form"></div>
    <textarea class="comp-raw hide mono" spellcheck="false" placeholder='{"foo":123}'></textarea>
    <div class="row" style="justify-content:flex-end">
      <button class="ok-btn btn-apply-raw hide">从JSON载入表单</button>
    </div>
  </div>
</template>

<script>
/** ========== 枚举 & 常量 ========== */
// 1) 附魔（Java 1.21+，含密度/破盾/乘风）
const ENCHANT_IDS = [
  "aqua_affinity","bane_of_arthropods","binding_curse","blast_protection","breach",
  "channeling","density","depth_strider","efficiency","feather_falling","fire_aspect",
  "fire_protection","flame","fortune","frost_walker","impaling","infinity","knockback",
  "looting","loyalty","luck_of_the_sea","lure","mending","multishot","piercing","power",
  "projectile_protection","protection","punch","quick_charge","respiration","riptide",
  "sharpness","silk_touch","smite","soul_speed","sweeping_edge","swift_sneak",
  "thorns","unbreaking","vanishing_curse","wind_burst"
].map(x=>"minecraft:"+x);

// 2) 聊天/文本预设颜色
const CHAT_COLORS = [
  "black","dark_blue","dark_green","dark_aqua","dark_red","dark_purple","gold",
  "gray","dark_gray","blue","green","aqua","red","light_purple","yellow","white"
];

// 3) 羊毛染料色（供 DYED_COLOR、Banner base 等）
const DYE_COLORS = [
  ["white","#F9FFFE"],["orange","#F9801D"],["magenta","#C74EBD"],["light_blue","#3AB3DA"],
  ["yellow","#FED83D"],["lime","#80C71F"],["pink","#F38BAA"],["gray","#474F52"],
  ["light_gray","#9D9D97"],["cyan","#169C9C"],["purple","#8932B8"],["blue","#3C44AA"],
  ["brown","#835432"],["green","#5E7C16"],["red","#B02E26"],["black","#1D1D21"]
];

// 4) 属性修饰符：可选槽位
const ATTR_SLOTS = ["head","chest","legs","feet","mainhand","offhand"];

// 5) 属性类型（以 1.21+ 常见 vanilla 为主；使用 namespaced id）
const ATTR_TYPES = [
  "minecraft:generic.max_health","minecraft:generic.follow_range","minecraft:generic.knockback_resistance",
  "minecraft:generic.movement_speed","minecraft:generic.flying_speed","minecraft:generic.attack_damage",
  "minecraft:generic.attack_knockback","minecraft:generic.attack_speed","minecraft:generic.armor",
  "minecraft:generic.armor_toughness","minecraft:generic.luck","minecraft:generic.max_absorption",
  "minecraft:generic.safe_fall_distance","minecraft:generic.scale","minecraft:generic.step_height",
  "minecraft:generic.gravity","minecraft:generic.jump_strength","minecraft:generic.fall_damage_multiplier",
  "minecraft:generic.mining_efficiency","minecraft:generic.movement_efficiency","minecraft:generic.oxygen_bonus",
  "minecraft:generic.water_movement_efficiency","minecraft:generic.submerged_mining_speed",
  "minecraft:generic.sneaking_speed","minecraft:generic.sweeping_damage_ratio","minecraft:generic.explosion_knockback_resistance",
  // 玩家专属交互距离（展示常见需求）
  "minecraft:player.block_interaction_range","minecraft:player.entity_interaction_range"
];

// 6) 属性修饰符运算字面值（1.20.5+ 改名）
const ATTR_OPS = ["add_value","add_multiplied_base","add_multiplied_total"];

// 7) 物品稀有度
const RARITIES = ["common","uncommon","rare","epic"];

// 工具函数：创建选项
function fillOptions(sel, list, {valueAsText=false}={}){
  sel.innerHTML = "";
  list.forEach(v=>{
    const opt = document.createElement("option");
    opt.value = valueAsText? v : v;
    opt.textContent = v;
    sel.appendChild(opt);
  });
}

// 颜色选择器（预设 + 自定义）
function makeColorPicker({presetList, withCustomHex=true, initial}){
  const wrap = document.createElement("div");
  const select = document.createElement("select");
  const customWrap = document.createElement("div");
  customWrap.className = "row";
  const colorInput = document.createElement("input");
  colorInput.type = "color";
  const hexInput = document.createElement("input");
  hexInput.type = "text";
  hexInput.placeholder = "#RRGGBB";
  customWrap.append(colorInput, hexInput);

  // 预设 + 自定义
  const opts = [...presetList.map(x=>Array.isArray(x)? x[0]:x), "custom"];
  fillOptions(select, opts);
  wrap.append(select);
  wrap.append(customWrap);
  customWrap.style.display = "none";

  // 初始值判定
  if(initial){
    const asName = (presetList.find(x=>Array.isArray(x)? x[1].toLowerCase()===initial.toLowerCase(): false));
    if(CHAT_COLORS.includes(initial)) select.value = initial;
    else if(asName){ select.value = asName[0]; colorInput.value = asName[1]; hexInput.value = asName[1]; }
    else{ select.value = "custom"; customWrap.style.display="flex";
      const hsv = initial.startsWith("#")? initial : "#ffffff";
      colorInput.value = hsv; hexInput.value = hsv;
    }
  }

  // 联动
  select.addEventListener("change", ()=>{
    customWrap.style.display = (select.value==="custom")? "flex":"none";
  });
  colorInput.addEventListener("input", ()=>{ hexInput.value = colorInput.value });
  hexInput.addEventListener("input", ()=>{
    const v = hexInput.value.trim();
    if(/^#?[0-9a-fA-F]{6}$/.test(v)) colorInput.value = v.startsWith("#")? v : ("#"+v);
  });

  return {
    el: wrap,
    getValue(){
      if(select.value==="custom"){
        const v = hexInput.value.trim();
        if(/^#?[0-9a-fA-F]{6}$/.test(v)) return (v.startsWith("#")? v : "#"+v);
        return null;
      }else{
        return select.value;
      }
    },
    setValue(v){
      if(CHAT_COLORS.includes(v)){ select.value=v; customWrap.style.display="none"; }
      else{
        select.value="custom"; customWrap.style.display="flex";
        const hsv = v.startsWith("#")? v : "#ffffff";
        colorInput.value=hsv; hexInput.value=hsv;
      }
    }
  }
}

// 小工具：namespacing
function ns(id){
  if(!id) return id;
  return id.includes(":")? id : ("minecraft:"+id);
}

/** ========== 组件目录（支持：可视化 / JSON 双向） ========== 
 * 说明：
 * id —— 不带命名空间；最终构建时自动加 minecraft:
 * kind: "helper"（可视化）|"raw"
 * helper 需要实现 build(formEl)->value 与 fill(formEl,value) 两个函数
 */
const CATALOG = [
  // ---- 核心文本类 ----
  {id:"item_name", title:"显示名（item_name）", kind:"helper", group:"文本",
   helper:{
     render(){
       const box = document.createElement("div");
       const input = document.createElement("input");
       input.placeholder = "纯文本（JSON Text 更灵活，建议用 lore ）";
       const color = makeColorPicker({presetList:CHAT_COLORS, initial:"white"});
       box.append(labelOf("文本"),input, labelOf("颜色（聊天色）"), color.el);
       return {el:box, get:()=>({text:input.value||"", color: color.getValue()||"white"}), set:(v={})=>{
         input.value = v.text??"";
         if(v.color) color.setValue(v.color);
       }};
     },
     build(v){ // 转 JSON Text
       return {"text": v.text||"", "color": (v.color||"white")};
     },
     fill(value){ // JSON 反填（兼容 text/translate 只做 text）
       const text = (typeof value==="object" && value)? (value.text??""): (""+value);
       const color = (typeof value==="object" && value && value.color)||"white";
       return {text,color};
     }
   }
  },
  {id:"lore", title:"物品描述（lore）", kind:"helper", group:"文本",
   helper:{
     render(){
       const wrap = document.createElement("div");
       const list = document.createElement("div"); list.className="list";
       const btn = document.createElement("button"); btn.textContent="新增一行";
       const makeLine = (line={text:"",color:"gray"})=>{
         const row = document.createElement("div"); row.className="item";
         const txt = document.createElement("input"); txt.placeholder="这一行的文本";
         txt.value = line.text||"";
         const color = makeColorPicker({presetList:CHAT_COLORS, initial: line.color||"gray"});
         const rm = document.createElement("button"); rm.textContent="删除"; rm.className="danger-btn";
         rm.onclick=()=> row.remove();
         row.append(labelOf("文本"),txt,labelOf("颜色"),color.el,rm);
         row.getValue = ()=>({text:txt.value||"",color:color.getValue()||"gray"});
         row.setValue = v=>{ txt.value=v.text||""; color.setValue(v.color||"gray"); };
         list.append(row);
       };
       btn.onclick=()=>makeLine({});
       wrap.append(list,btn);
       makeLine({});
       return {el:wrap, get:()=>Array.from(list.children).map(ch=>({text:ch.getValue().text,color:ch.getValue().color})), set:(arr=[])=>{
         list.innerHTML=""; (arr.length?arr:[{text:"",color:"gray"}]).forEach(makeLine);
       }};
     },
     build(arr){ return {lines: arr.map(x=>({text:x.text||"", color:x.color||"gray"}))}; },
     fill(v){ return (v && Array.isArray(v.lines))? v.lines.map(x=>({text:x.text||"",color:x.color||"gray"})) : []; }
   }
  },

  // ---- 附魔（enchantments / stored_enchantments）----
  {id:"enchantments", title:"附魔（enchantments）", kind:"helper", group:"属性/战斗",
   helper:{
     render(){
       const box = document.createElement("div"); const list=document.createElement("div"); list.className="list";
       const btn = document.createElement("button"); btn.textContent="添加附魔";
       const makeRow = (row={id:"minecraft:sharpness",lvl:5})=>{
         const it = document.createElement("div"); it.className="item";
         const idSel = document.createElement("select"); fillOptions(idSel, ENCHANT_IDS);
         idSel.value = row.id||"minecraft:sharpness";
         const lvl = document.createElement("input"); lvl.type="number"; lvl.min=1; lvl.max=255; lvl.value = row.lvl||1;
         const rm = document.createElement("button"); rm.textContent="删除"; rm.className="danger-btn";
         rm.onclick=()=>it.remove();
         it.append(labelOf("附魔 ID"), idSel, labelOf("等级"), lvl, rm);
         it.getValue = ()=>({id:idSel.value, lvl:parseInt(lvl.value||"1",10)});
         list.append(it);
       };
       btn.onclick=()=>makeRow({});
       box.append(list,btn);
       makeRow({});
       return {el:box, get:()=>Array.from(list.children).map(c=>c.getValue()), set:(arr=[])=>{
         list.innerHTML=""; (arr.length?arr:[{id:"minecraft:sharpness",lvl:5}]).forEach(makeRow);
       }};
     },
     build(rows){
       const levels = {};
       rows.forEach(r=>{ if(r.id) levels[r.id]=r.lvl||1; });
       return {levels};
     },
     fill(v){
       if(v && typeof v==="object" && v.levels){
         return Object.entries(v.levels).map(([id,lvl])=>({id,lvl}));
       }
       return [];
     }
   }
  },
  {id:"stored_enchantments", title:"书本附魔（stored_enchantments）", kind:"helper", group:"属性/战斗",
    helper: { // 复用同上
      render(){ return CATALOG.find(x=>x.id==="enchantments").helper.render(); },
      build(rows){ return CATALOG.find(x=>x.id==="enchantments").helper.build(rows); },
      fill(v){ return CATALOG.find(x=>x.id==="enchantments").helper.fill(v); }
    }
  },

  // ---- 属性修饰符（attribute_modifiers）----
  {id:"attribute_modifiers", title:"属性修饰符（attribute_modifiers）", kind:"helper", group:"属性/战斗",
   helper:{
     render(){
       const box = document.createElement("div"); const list=document.createElement("div"); list.className="list";
       const btn = document.createElement("button"); btn.textContent="添加修饰符";
       const makeRow = (row={type:"minecraft:generic.attack_damage",amount:5,op:"add_value",slots:["mainhand"],id:"example:ad"})=>{
         const it = document.createElement("div"); it.className="item";
         const typeSel=document.createElement("select"); fillOptions(typeSel, ATTR_TYPES);
         typeSel.value = row.type||"minecraft:generic.attack_damage";
         const amount=document.createElement("input"); amount.type="number"; amount.step="any"; amount.value=row.amount??0;
         const opSel=document.createElement("select"); fillOptions(opSel, ATTR_OPS);
         opSel.value=row.op||"add_value";
         const idInput=document.createElement("input"); idInput.placeholder="修饰符唯一 id（命名空间）"; idInput.value=row.id||"";
         // 槽位：多选勾选
         const slotsWrap=document.createElement("div"); slotsWrap.className="checkboxes";
         ATTR_SLOTS.forEach(s=>{
           const lab=document.createElement("label");
           const ck=document.createElement("input"); ck.type="checkbox"; ck.value=s;
           if((row.slots||[]).includes(s)) ck.checked=true;
           lab.append(ck, document.createTextNode(" "+s));
           slotsWrap.append(lab);
         });
         const rm = document.createElement("button"); rm.textContent="删除"; rm.className="danger-btn"; rm.onclick=()=>it.remove();
         it.append(labelOf("属性类型"),typeSel,labelOf("数值（amount）"),amount,labelOf("运算（operation）"),opSel,
                   labelOf("唯一ID"),idInput,labelOf("生效栏位"),slotsWrap,rm);
         it.getValue=()=>({
            type:typeSel.value, amount: Number(amount.value||0), operation: opSel.value,
            id: idInput.value? ns(idInput.value.trim()): undefined,
            slot: Array.from(slotsWrap.querySelectorAll("input[type=checkbox]:checked")).map(x=>x.value)
         });
         list.append(it);
       };
       btn.onclick=()=>makeRow({});
       box.append(list,btn);
       makeRow({});
       return {el:box, get:()=>({modifiers:Array.from(list.children).map(c=>c.getValue())}), set:(v)=>{
         list.innerHTML=""; (v?.modifiers||[]).forEach(x=>makeRow({
           type:x.type, amount:x.amount, op:x.operation, slots:x.slot, id:x.id
         }));
         if(!list.children.length) makeRow({});
       }};
     },
     build(v){ return v; },
     fill(v){ return v||{modifiers:[]}; }
   }
  },

  // ---- 染色（dyed_color）----
  {id:"dyed_color", title:"染色（dyed_color）", kind:"helper", group:"外观",
   helper:{
     render(){
       const wrap=document.createElement("div");
       const picker = makeColorPicker({presetList:DYE_COLORS, initial:"#ffffff"});
       const showGlint=document.createElement("select");
       fillOptions(showGlint,["默认","强制开启","强制关闭"]);
       wrap.append(labelOf("颜色"),picker.el,labelOf("附魔光效覆盖"),showGlint);
       return {el:wrap, get:()=>{
         const v = picker.getValue();
         let glint = null;
         if(showGlint.value==="强制开启") glint=true; else if(showGlint.value==="强制关闭") glint=false;
         return {color:v, show_glint_override: glint};
       }, set:(v)=>{
         if(v?.color) picker.setValue(v.color);
         if(typeof v?.show_glint_override==="boolean") showGlint.value = v.show_glint_override? "强制开启":"强制关闭";
         else showGlint.value="默认";
       }};
     },
     build(v){ return v; },
     fill(v){ return v||{}; }
   }
  },

  // ---- 稀有度（rarity）----
  {id:"rarity", title:"稀有度（rarity）", kind:"helper", group:"外观",
   helper:{
     render(){
       const s=document.createElement("select"); fillOptions(s, RARITIES);
       return {el:s, get:()=>s.value, set:v=>{ if(RARITIES.includes(v)) s.value=v; }};
     },
     build(v){ return v; }, fill(v){ return v; }
   }
  },

  // ---- 药水（potion_contents，自定义颜色支持）----
  {id:"potion_contents", title:"药水内容（potion_contents）", kind:"helper", group:"功能",
   helper:{
     render(){
       const box=document.createElement("div");
       const pot=document.createElement("input"); pot.placeholder='药水ID（如 minecraft:long_swiftness）';
       const picker = makeColorPicker({presetList:DYE_COLORS, initial:"custom"});
       box.append(labelOf("药水ID"),pot,labelOf("自定义颜色（可选）"),picker.el);
       return {el:box, get:()=>({potion: pot.value? ns(pot.value.trim()): undefined, custom_color: picker.getValue()||undefined}),
               set:(v)=>{ pot.value=v?.potion||""; if(v?.custom_color) picker.setValue(v.custom_color); }};
     },
     build(v){ const out={}; if(v.potion) out.potion=v.potion; if(v.custom_color) out.custom_color=v.custom_color; return out; },
     fill(v){ return v||{}; }
   }
  },

  // ---- 容器（container / container_loot）----
  {id:"container", title:"容器（container）", kind:"helper", group:"容器",
   helper:{
     render(){
       const box=document.createElement("div"); const list=document.createElement("div"); list.className="list";
       const btn=document.createElement("button"); btn.textContent="添加槽位物品";
       const makeRow = (row={slot:0,id:"minecraft:stone",count:1,components:{}})=>{
         const it=document.createElement("div"); it.className="item";
         const slot=document.createElement("input"); slot.type="number"; slot.min=0; slot.max=255; slot.value=row.slot??0;
         const id=document.createElement("input"); id.placeholder="物品ID"; id.value=row.id||"";
         const count=document.createElement("input"); count.type="number"; count.min=1; count.max=99; count.value=row.count??1;
         const comp=document.createElement("textarea"); comp.placeholder='嵌套 components（可选），例：{"minecraft:enchantments":{"levels":{"minecraft:mending":1}}}';
         comp.value = row.components? JSON.stringify(row.components): "";
         const rm=document.createElement("button"); rm.textContent="删除"; rm.className="danger-btn"; rm.onclick=()=>it.remove();
         it.append(labelOf("槽位"),slot,labelOf("物品ID"),id,labelOf("数量"),count,labelOf("子组件（JSON）"),comp,rm);
         it.getValue=()=>{
           let nested=null;
           const raw=comp.value.trim();
           if(raw){ try{ nested=JSON.parse(raw); }catch(e){ alert("子组件 JSON 解析失败："+e.message); throw e; } }
           return {slot:parseInt(slot.value||"0",10), id:ns(id.value.trim()), count:parseInt(count.value||"1",10), components:nested};
         };
         list.append(it);
       };
       btn.onclick=()=>makeRow({});
       box.append(list,btn);
       makeRow({});
       return {el:box, get:()=>({slots:Array.from(list.children).map(c=>c.getValue())}), set:(v)=>{
         list.innerHTML=""; (v?.slots||[]).forEach(makeRow);
         if(!list.children.length) makeRow({});
       }};
     },
     build(v){
       // 组件结构：数组物品，转为 {<slot>:{id,count,components?}} 或官方结构（此处采用数组 entries）
       // 为保持兼容，使用数组：[{slot, item:{id,count,components?}}]
       return v.slots.map(x=>{
         const it = {id:x.id, count:x.count};
         if(x.components) it.components=x.components;
         return {slot:x.slot, item:it};
       });
     },
     fill(v){
       // 兼容两种：数组 entries 或 map
       if(Array.isArray(v)){
         return {slots: v.map(ent=>({slot:ent.slot, id:ent.item?.id, count:ent.item?.count||1, components: ent.item?.components}))};
       }
       return {slots:[]};
     }
   }
  },
  {id:"container_loot", title:"容器战利品（container_loot）", kind:"helper", group:"容器",
    helper:{
      render(){
        const wrap=document.createElement("div");
        const lt=document.createElement("input"); lt.placeholder="战利品表 ID（如 minecraft:chests/simple_dungeon）";
        const seed=document.createElement("input"); seed.type="number"; seed.placeholder="seed（可选）";
        wrap.append(labelOf("战利品表 ID"),lt,labelOf("seed"),seed);
        return {el:wrap, get:()=>({loot_table: ns(lt.value.trim()), seed: seed.value? Number(seed.value): undefined}),
                set:(v)=>{ lt.value=v?.loot_table||""; seed.value= (v?.seed??""); }};
      },
      build(v){ const out={loot_table:v.loot_table}; if(v.seed!=null && v.seed!=="") out.seed=v.seed; return out; },
      fill(v){ return v||{}; }
    }
  },

  // ---- 其它（保持可视化/JSON切换能力，暂以原始 JSON）----
  {id:"custom_model_data", title:"自定义模型（custom_model_data）", kind:"raw", group:"外观", template:{}} ,
  {id:"trim", title:"盔甲纹饰（trim）", kind:"raw", group:"外观", template:{}},
  {id:"unbreakable", title:"不可破坏（unbreakable）", kind:"raw", group:"属性/战斗", template:{}},
  {id:"max_damage", title:"最大耐久（max_damage）", kind:"raw", group:"属性/战斗", template:0},
  {id:"damage", title:"当前磨损（damage）", kind:"raw", group:"属性/战斗", template:0},
  {id:"repair_cost", title:"修复开销（repair_cost）", kind:"raw", group:"属性/战斗", template:0},
  {id:"charged_projectiles", title:"装填弹药（charged_projectiles）", kind:"raw", group:"战术", template:[]},
  {id:"bundle_contents", title:"捆包内容（bundle_contents）", kind:"raw", group:"容器", template:[]},
  {id:"block_entity_data", title:"方块实体数据（block_entity_data）", kind:"raw", group:"高级", template:{}},
  {id:"bucket_entity_data", title:"桶内实体数据（bucket_entity_data）", kind:"raw", group:"高级", template:{}},
  {id:"entity_data", title:"生成实体数据（entity_data）", kind:"raw", group:"高级", template:{}},
  {id:"can_place_on", title:"可放置于（can_place_on）", kind:"raw", group:"交互", template:{}},
  {id:"can_break", title:"可破坏（can_break）", kind:"raw", group:"交互", template:{}},
  {id:"hide_tooltip", title:"隐藏提示（hide_tooltip）", kind:"raw", group:"外观", template:{}},
  {id:"hide_additional_tooltip", title:"隐藏附加提示（hide_additional_tooltip）", kind:"raw", group:"外观", template:{}},
  {id:"rarity", title:"稀有度（rarity）", kind:"helper-ref", group:"外观", ref:"rarity"}, // 复用
];

// label 工具
function labelOf(text){ const l=document.createElement("label"); l.textContent=text; return l; }

/** ========== UI 初始化 ========== */
const itemIdEl = document.getElementById("itemId");
const countEl = document.getElementById("count");
const targetEl = document.getElementById("target");
const componentSelect = document.getElementById("componentSelect");
const componentsArea = document.getElementById("componentsArea");
const cmdEl = document.getElementById("cmd");
const rawComponentsEl = document.getElementById("rawComponents");

(function init(){
  // 填充组件选择器（按组分段）
  const groups = [...new Set(CATALOG.map(x=>x.group))];
  componentSelect.innerHTML="";
  groups.forEach(g=>{
    const og = document.createElement("optgroup"); og.label = g;
    CATALOG.filter(x=>x.group===g).forEach(c=>{
      const o=document.createElement("option"); o.value=c.id; o.textContent=c.title; og.append(o);
    });
    componentSelect.append(og);
  });

  // 默认示例
  itemIdEl.value = "netherite_sword";
  addComponentCard("enchantments", {levels:{"minecraft:sharpness":5}});
  addComponentCard("attribute_modifiers", {modifiers:[{type:"minecraft:generic.attack_speed",amount:0.2,operation:"add_multiplied_base",id:"demo:as",slot:["mainhand"]}]});
  updatePreview();
})();

/** ========== 组件卡片：创建/双向切换 ========== */
document.getElementById("addComponent").addEventListener("click", ()=>{
  const id = componentSelect.value;
  addComponentCard(id, null);
  updatePreview();
});

function addComponentCard(id, initialValue){
  const def = CATALOG.find(x=>x.id===id);
  if(!def){ alert("未知组件："+id); return; }

  // 如果是 helper-ref，复用另一个定义
  let real = def;
  if(def.kind==="helper-ref"){
    real = CATALOG.find(x=>x.id===def.ref);
  }

  const tpl = document.getElementById("component-card");
  const node = tpl.content.firstElementChild.cloneNode(true);
  node.dataset.comp = def.id;
  node.querySelector(".comp-title").textContent = def.title;
  node.querySelector(".comp-id").textContent = "minecraft:"+def.id;

  const formBox = node.querySelector(".comp-form");
  const rawBox  = node.querySelector(".comp-raw");
  const btnToggle = node.querySelector(".btn-toggle");
  const btnRemove = node.querySelector(".btn-remove");
  const btnApplyRaw = node.querySelector(".btn-apply-raw");

  let formAPI = null;     // {get(), set(), el}
  let lastJSON = null;    // 切换记忆

  if(real.kind==="helper"){
    // 渲染 helper
    formAPI = real.helper.render();
    formBox.append(formAPI.el);
    // 初始填充
    if(initialValue!=null){
      try{
        const fillData = real.helper.fill(initialValue);
        if(formAPI.set) formAPI.set(fillData);
      }catch(e){ console.warn("fill parse err:",e); }
      rawBox.value = JSON.stringify(initialValue, null,2);
    }else{
      // 用 build 的默认值填 raw
      const v = formAPI.get? formAPI.get(): null;
      rawBox.value = JSON.stringify(real.helper.build(v),null,2);
    }
    // 切换到 JSON
    btnToggle.addEventListener("click", ()=>{
      if(rawBox.classList.contains("hide")){
        // 生成 JSON
        const v = formAPI.get? formAPI.get(): null;
        const value = real.helper.build(v);
        rawBox.value = JSON.stringify(value, null,2);
        formBox.classList.add("hide");
        rawBox.classList.remove("hide");
        btnApplyRaw.classList.remove("hide");
        btnToggle.textContent="切回可视化";
      }else{
        // 从 JSON 回填
        try{
          const obj = JSON.parse(rawBox.value||"{}");
          const fillData = real.helper.fill(obj);
          if(formAPI.set) formAPI.set(fillData);
          rawBox.classList.add("hide");
          btnApplyRaw.classList.add("hide");
          formBox.classList.remove("hide");
          btnToggle.textContent="转为原始JSON";
          updatePreview();
        }catch(e){ alert("JSON 解析失败："+e.message); }
      }
    });
    // 显式“从JSON载入表单”
    btnApplyRaw.addEventListener("click", ()=>{
      try{
        const obj = JSON.parse(rawBox.value||"{}");
        const fillData = real.helper.fill(obj);
        if(formAPI.set) formAPI.set(fillData);
        updatePreview();
      }catch(e){ alert("JSON 解析失败："+e.message); }
    });

  }else{
    // raw-only
    formBox.classList.add("hide");
    rawBox.classList.remove("hide");
    btnApplyRaw.classList.add("hide"); // 原生的没有可视化
    btnToggle.disabled = true;
    rawBox.value = JSON.stringify((initialValue??def.template), null, 2);
  }

  btnRemove.addEventListener("click", ()=>{ node.remove(); updatePreview(); });
  // 任意输入变化时更新预览
  node.addEventListener("input", ()=>updatePreview());
  componentsArea.append(node);
}

/** ========== 组件数据聚合 ========== */
function collectComponents(){
  const entries = Array.from(componentsArea.children).map(card=>{
    const id = card.dataset.comp;
    const def = CATALOG.find(x=>x.id===id) || {};
    const real = def.kind==="helper-ref" ? CATALOG.find(x=>x.id===def.ref) : def;
    const rawEl = card.querySelector(".comp-raw");
    const formEl = card.querySelector(".comp-form");

    if(real.kind==="helper"){
      // 取当前视图：若在 JSON 视图，则直接读 JSON；否则从表单 build
      if(!rawEl.classList.contains("hide")){
        try{
          return ["minecraft:"+id, JSON.parse(rawEl.value||"{}")];
        }catch(e){
          throw new Error(def.title+" 的 JSON 无法解析："+e.message);
        }
      }else{
        const api = Array.from(formEl.children).find(()=>true); // 占位
        const compDef = CATALOG.find(x=>x.id===id);
        const apiParent = card.querySelector(".comp-form").firstChild.__apiRef;
        // 实际上我们在 helper.render 返回对象
        // 这里简单重新定位：通过保存闭包变量
        const getter = card.querySelector(".comp-form")._get || (()=> (compDef.helper.render().get?.() ?? null));
        const value = card.querySelector(".comp-form")._build ? card.querySelector(".comp-form")._build(getter()) : compDef.helper.build(getter());
        return ["minecraft:"+id, value];
      }
    }else{
      // raw-only
      try{
        return ["minecraft:"+id, JSON.parse(rawEl.value||"{}")];
      }catch(e){
        throw new Error(def.title+" 的 JSON 无法解析："+e.message);
      }
    }
  });

  const obj={};
  entries.forEach(([k,v])=>obj[k]=v);
  return obj;
}

/** ========== 预览命令生成 ========== */
function updatePreview(){
  try{
    const item = ns(itemIdEl.value.trim() || "minecraft:stone");
    const cnt = Math.max(1, parseInt(countEl.value||"1",10));
    const comps = collectComponents();
    rawComponentsEl.value = JSON.stringify(comps, null, 2);
    const compsInline = Object.entries(comps).map(([k,v])=>{
      return `${k}=${jsonInline(v)}`;
    }).join(",");
    const cmd = `/give ${targetEl.value.trim()||"@p"} ${item}${cnt>1? " "+cnt:""}[${compsInline}]`;
    cmdEl.textContent = cmd;
  }catch(e){
    cmdEl.textContent = "⚠️ "+e.message;
  }
}

// 内联 JSON：尽量短，但字符串保留引号
function jsonInline(v){
  if(v==null) return "null";
  if(typeof v==="string" || typeof v==="number" || typeof v==="boolean") return JSON.stringify(v);
  if(Array.isArray(v)) return `[${v.map(jsonInline).join(",")}]`;
  // 对象：保序
  return `{${Object.entries(v).map(([k,val])=>`${JSON.stringify(k)}:${jsonInline(val)}`).join(",")}}`;
}

/** ========== 顶部原始 JSON 面板 ========== */
document.getElementById("applyJson").addEventListener("click", ()=>{
  try{
    const obj = JSON.parse(rawComponentsEl.value||"{}");
    // 覆盖当前 UI：先清空
    componentsArea.innerHTML="";
    Object.entries(obj).forEach(([fullId,val])=>{
      const id = fullId.replace(/^minecraft:/,"");
      addComponentCard(id, val);
    });
    updatePreview();
    alert("已载入并切换为可视化编辑。");
  }catch(e){
    alert("JSON 解析失败："+e.message);
  }
});

document.getElementById("validateJson").addEventListener("click", ()=>{
  try{
    JSON.parse(rawComponentsEl.value||"{}");
    alert("JSON 格式正确 ✅");
  }catch(e){
    alert("JSON 格式错误："+e.message);
  }
});

document.getElementById("copyCmd").addEventListener("click", ()=>{
  navigator.clipboard.writeText(cmdEl.textContent||"").then(()=>toast("命令已复制"));
});
document.getElementById("copyJson").addEventListener("click", ()=>{
  navigator.clipboard.writeText(rawComponentsEl.value||"").then(()=>toast("JSON 已复制"));
});

function toast(msg){
  const t=document.createElement("div");
  t.textContent=msg; t.style.position="fixed"; t.style.right="14px"; t.style.bottom="14px";
  t.style.background="#111c"; t.style.border="1px solid var(--border)"; t.style.padding="8px 12px";
  t.style.borderRadius="8px"; t.style.backdropFilter="blur(4px)";
  document.body.append(t); setTimeout(()=>t.remove(),1200);
}

// 监听整体变更
["input","change"].forEach(ev=>{
  document.getElementById("left").addEventListener(ev, e=>{
    if(e.target.closest("#componentsArea")) { /* 在卡片内已绑定 */ }
    updatePreview();
  }, true);
});
</script>
</body>
</html>
